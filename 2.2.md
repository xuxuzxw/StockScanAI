### **A股量化投研平台 V2.2 - “架构优化与深度集成” 项目规划**

**文档版本：** 1.0
**核心目标：** 在 V2.1 坚实的功能基础上，进行一次深刻的架构性优化和功能性集成。目标不是增加更多的数据接口，而是**从根本上提升系统的可扩展性、后台处理效率、策略研究深度和最终用户体验**，为平台迈向 V3.0 的宏伟蓝图扫清所有障碍。

#### **一、 V2.2 版本指导原则**

我们将严格遵循以下原则，确保本次升级的平稳与成功：

1.  **兼容性优先 (Compatibility First):** 所有重构任务都必须设计平滑的过渡方案。在新旧代码共存的阶段，确保平台核心功能不受影响。我们将通过创建专用的迁移脚本来管理数据的迁移，而不是粗暴地删除旧有结构。
2.  **健壮性加固 (Robustness Enhancement):** 优化的目标是减少系统中的“脆弱环节”（如对本地文件的依赖），创建更可靠、更具容错性的自动化流程。
3.  **合理性与前瞻性 (Logical & Forward-looking):** 每一项改动，都必须从“全市场、长期运行”的视角出发，解决潜在的性能瓶颈和管理难题，为未来更复杂的功能集成（如分钟线数据、更高级的机器学习模型）预留空间。

---

#### **二、 V2.2 版本四大核心任务模块**

本次升级将围绕我们审查中发现的四个关键点，分模块进行。

##### **任务模块一：数据库架构优化 (“万表归一”)**

* **目标：** 彻底解决财务指标数据“一股一表”的设计缺陷，将其重构为统一的、可扩展的单一主表。
* **合理性与健壮性：**
    * **【现状】** 当前为每只股票创建一张财务表（`fina_indicator_[代码]`），在全市场5000+股票的场景下，将导致数据库难以管理和查询，存在严重性能瓶颈。
    * **【优化】** 合并为一张 `financial_indicators` 大表，将极大提升全市场横向查询（例如“查询所有ROE大于10%的股票”）的性能，并简化数据库维护。
* **实施步骤 (考虑兼容性)：**
    1.  **Step 1 (数据库层):** 在 `initialize_database.py` 中，创建新的、统一的 `financial_indicators` 表，并将 `ts_code` 作为其核心字段之一。
    2.  **Step 2 (数据迁移):** **【关键】** 创建一个全新的、一次性的迁移脚本，例如 `migrate_fina_data.py`。该脚本负责读取所有旧的 `fina_indicator_...` 小表中的数据，并将其统一写入到新的 `financial_indicators` 大表中。
    3.  **Step 3 (数据层):** 重构 `data.py` 中的 `get_fina_indicator` 方法，使其不再创建小表，而是直接向新的 `financial_indicators` 大表进行高效的 `UPSERT` 操作。
    4.  **Step 4 (清理与兼容):** 在确认数据迁移成功后，更新 `quant_engine.py` 中所有调用 `get_fina_indicator` 的地方，确保其能正确处理从大表返回的数据。最后，可以安全地废弃并删除所有旧的小表。

##### **任务模块二：功能深度集成 (“唤醒沉睡的功能”)**

* **目标：** 将 `quant_engine.py` 中已经存在的 `AdaptiveAlphaStrategy`（自适应权重）和 `MLAlphaStrategy`（机器学习）两大高级策略，正式集成到前端“回测实验室”中，供用户选择和使用。
* **合理性与健壮性：**
    * **【现状】** 平台的核心“大脑”（高级策略）尚未与“身体”（前端界面）完全连接，其价值被封印。
    * **【优化】** 激活这些功能，将使平台从一个多因子“展示”工具，**质变为一个真正的、可交互的“高级策略研发”平台**，极大提升其专业价值。
* **实施步骤：**
    1.  **Step 1 (前端UI):** 在 `app.py` 的“回测实验室”中，增加一个新的 `st.selectbox` 或 `st.radio`，让用户可以在“固定权重”、“自适应权重 (IC-IR)”和“机器学习 (LGBM)”三种策略中进行选择。
    2.  **Step 2 (后端逻辑):** 根据用户的选择，在后端的回测执行逻辑中，实例化对应的策略类 (`AdaptiveAlphaStrategy` 或 `MLAlphaStrategy`)。
    3.  **Step 3 (数据流):** 确保为这些高级策略准备并传递所需的数据（如完整的历史价格序列用于计算IC，或完整的因子-收益数据用于ML模型预测）。
    4.  **Step 4 (健壮性):** 增加必要的检查。例如，如果用户选择了“机器学习策略”，但模型尚未训练，前端应给出清晰的提示，而不是直接报错。

##### **任务模块三：用户体验打磨 (“更智能的仪表盘”)**

* **目标：** 调整应用的默认启动页面，使其更符合专业投研人员“自顶向下”的分析习惯。
* **合理性：**
    * **【现状】** 应用启动后默认进入某只特定股票的深度分析页。
    * **【优化】** 专业人士通常先看大盘、再看行业、最后才到个股。将默认页面改为“市场全景”或“智能选股排名”，能提供一个更宏观的开局视野，让用户首先把握市场脉搏。
* **实施步骤：**
    1.  **Step 1 (重新排序):** 在 `app.py` 中，调整 `tab_list` 列表中各个标签页的顺序，将“**🎯 市场全景**”或“**🏆 智能选股排名**”移动到列表的第一个位置。这是最简单且最有效的实现方式。
    2.  **Step 2 (兼容性测试):** 确保在调整顺序后，从侧边栏选择股票、以及从排名页下钻到个股分析的交互逻辑依然流畅无误。

##### **任务模块四：后台流程优化 (“无缝衔接”)**

* **目标：** 将 `data_extractor.py` 和 `factor_calculator.py` 两个独立的后台脚本，合并为一个统一、健壮的“每日数据管道”脚本。
* **健壮性与合理性：**
    * **【现状】** 两个脚本通过本地HDF5文件进行数据传递，这引入了对磁盘I/O的依赖，增加了潜在的故障点（如磁盘空间、读写权限、文件损坏等）。
    * **【优化】** 合并后的单一脚本，可以在内存中直接传递数据（Pandas DataFrame），形成一个原子化的、无缝衔接的任务流，从而**提升执行效率**和**系统稳定性**。
* **实施步骤：**
    1.  **Step 1 (创建新脚本):** 创建一个新的统一脚本，例如 `run_daily_pipeline.py`。
    2.  **Step 2 (代码迁移):** 将 `data_extractor.py` 的数据抽取逻辑，和 `factor_calculator.py` 的因子计算逻辑，依次迁移到新脚本的函数中。
    3.  **Step 3 (逻辑衔接):** 修改因子计算函数，使其直接接收数据抽取函数返回的 DataFrame 对象作为输入，而不是从本地文件读取。
    4.  **Step 4 (更新调度):** 更新 `scheduler.py` 和 `一键初始化全部数据.bat` 脚本，让它们调用这个新的 `run_daily_pipeline.py` 脚本，并废弃对旧脚本的调用。

---

#### **三、 V2.2 版本实施路线图 (Roadmap)**

为了确保升级过程的平稳，我建议我们按照以下顺序，分阶段实施：

1.  **第一阶段：奠定基石 (Foundation)**
    * 执行 **任务模块一 (数据库架构优化)**。这是最底层的、最核心的重构，应优先完成。
2.  **第二阶段：优化引擎 (Engine)**
    * 执行 **任务模块四 (后台流程优化)**。在数据库结构稳定后，优化我们的数据“发动机”。
3.  **第三阶段：激活大脑 (Activation)**
    * 执行 **任务模块二 (功能深度集成)**。在后台引擎优化完毕后，将强大的策略分析能力释放到前端。
4.  **第四阶段：打磨体验 (Polishing)**
    * 执行 **任务模块三 (用户体验打磨)**。在所有核心功能稳定后，进行最后的体验优化。