# æ•°æ®ç®¡é“ä¿®å¤æ€»ç»“

## é—®é¢˜æè¿°

åœ¨è¿è¡Œ`ä¸€é”®åˆå§‹åŒ–å…¨éƒ¨æ•°æ®.bat`æ—¶é‡åˆ°äº†ä»¥ä¸‹é”™è¯¯ï¼š

```
UnboundLocalError: cannot access local variable 'data' where it is not associated with a value
```

## é—®é¢˜åˆ†æ

### æ ¹æœ¬åŸå› 
åœ¨`run_daily_pipeline.py`çš„`extract_data`å‡½æ•°ä¸­ï¼Œå­˜åœ¨å˜é‡åå†²çªé—®é¢˜ï¼š

1. **æ¨¡å—çº§å¯¼å…¥**: `import data` - å¯¼å…¥äº†`data`æ¨¡å—
2. **å±€éƒ¨å˜é‡**: `data = func()` - åœ¨å¾ªç¯ä¸­åˆ›å»ºäº†åŒåçš„å±€éƒ¨å˜é‡
3. **åç§°å†²çª**: å½“åç»­ä»£ç å°è¯•ä½¿ç”¨`data.DataManager()`æ—¶ï¼Œ`data`å·²ç»è¢«é‡æ–°èµ‹å€¼ä¸ºå‡½æ•°è°ƒç”¨çš„ç»“æœ

### é”™è¯¯ä½ç½®
```python
# ç¬¬75è¡Œï¼šæ­£ç¡®ä½¿ç”¨æ¨¡å—
dm = data.DataManager()

# ç¬¬32è¡Œï¼šå˜é‡åå†²çª
for name, func in data_sources:
    data = func()  # è¿™é‡Œè¦†ç›–äº†æ¨¡å—å
    # ...
```

## ä¿®å¤æ–¹æ¡ˆ

### è§£å†³æ–¹æ³•
å°†å±€éƒ¨å˜é‡`data`é‡å‘½åä¸º`result_data`ï¼Œé¿å…ä¸å¯¼å…¥çš„æ¨¡å—åå†²çªï¼š

```python
# ä¿®å¤å‰
for name, func in data_sources:
    try:
        log.info(f"  ğŸ“Š è·å–{name}æ•°æ®...")
        data = func()  # é—®é¢˜ï¼šè¦†ç›–äº†æ¨¡å—å
        results[name] = data
        count = len(data) if data is not None and not data.empty else 0
        log.info(f"  âœ… {name}: {count} æ¡è®°å½•")
    except Exception as e:
        log.warning(f"  âš ï¸  {name}è·å–å¤±è´¥: {e}")
        results[name] = pd.DataFrame()

# ä¿®å¤å
for name, func in data_sources:
    try:
        log.info(f"  ğŸ“Š è·å–{name}æ•°æ®...")
        result_data = func()  # ä¿®å¤ï¼šä½¿ç”¨ä¸åŒçš„å˜é‡å
        results[name] = result_data
        count = len(result_data) if result_data is not None and not result_data.empty else 0
        log.info(f"  âœ… {name}: {count} æ¡è®°å½•")
    except Exception as e:
        log.warning(f"  âš ï¸  {name}è·å–å¤±è´¥: {e}")
        results[name] = pd.DataFrame()
```

## éªŒè¯ç»“æœ

### 1. æ¨¡å—å¯¼å…¥æµ‹è¯• âœ…
```python
import run_daily_pipeline
# ç»“æœ: å¯¼å…¥æˆåŠŸ
```

### 2. DataManageråˆå§‹åŒ–æµ‹è¯• âœ…
```python
import data
dm = data.DataManager()
# ç»“æœ: DataManageråˆå§‹åŒ–æˆåŠŸ
```

### 3. äº¤æ˜“æ—¥æœŸè·å–æµ‹è¯• âœ…
```python
from run_daily_pipeline import get_latest_available_trade_date
# ç»“æœ: æœ€æ–°äº¤æ˜“æ—¥: 20250718
```

### 4. æ•°æ®æŠ½å–åŠŸèƒ½æµ‹è¯• âœ…
```python
from run_daily_pipeline import extract_data
result = extract_data('20250718')
# ç»“æœ: æˆåŠŸæŠ½å–æ•°æ®ï¼ŒåŒ…å«7ä¸ªæ•°æ®é›†
```

## æµ‹è¯•ç»“æœè¯¦æƒ…

### æ•°æ®æŠ½å–æˆåŠŸç»Ÿè®¡
- **ç›®æ ‡è‚¡ç¥¨æ•°é‡**: 5,421åª
- **åŸºæœ¬æŒ‡æ ‡æ•°æ®**: 5,406æ¡è®°å½•
- **èµ„é‡‘æµå‘æ•°æ®**: 5,139æ¡è®°å½•  
- **é¾™è™æ¦œæ•°æ®**: 73æ¡è®°å½•
- **å¤§å®—äº¤æ˜“æ•°æ®**: 166æ¡è®°å½•
- **ç¼“å­˜å‘½ä¸­ç‡**: 100% (5421/5421åªè‚¡ç¥¨)

### è¿”å›æ•°æ®ç»“æ„
```python
result.keys() = [
    'stock_list',      # è‚¡ç¥¨åˆ—è¡¨
    'ts_codes',        # è‚¡ç¥¨ä»£ç åˆ—è¡¨
    'daily_prices_df', # æ—¥çº¿ä»·æ ¼æ•°æ®
    'daily_basics_df', # åŸºæœ¬æŒ‡æ ‡æ•°æ®
    'money_flow_df',   # èµ„é‡‘æµå‘æ•°æ®
    'top_list_df',     # é¾™è™æ¦œæ•°æ®
    'block_trade_df'   # å¤§å®—äº¤æ˜“æ•°æ®
]
```

## å½±å“èŒƒå›´

### ä¿®å¤å‰
- âŒ æ•°æ®ç®¡é“æ— æ³•å¯åŠ¨
- âŒ ä¸€é”®åˆå§‹åŒ–è„šæœ¬å¤±è´¥
- âŒ å› å­è®¡ç®—æ— æ³•è¿›è¡Œ

### ä¿®å¤å
- âœ… æ•°æ®ç®¡é“æ­£å¸¸è¿è¡Œ
- âœ… æ•°æ®æŠ½å–åŠŸèƒ½å®Œæ•´
- âœ… æ”¯æŒåç»­å› å­è®¡ç®—

## é¢„é˜²æªæ–½

### 1. å‘½åè§„èŒƒ
- é¿å…ä½¿ç”¨ä¸å¯¼å…¥æ¨¡å—ç›¸åŒçš„å˜é‡å
- ä½¿ç”¨æ›´å…·æè¿°æ€§çš„å˜é‡å
- éµå¾ªPythonå‘½åçº¦å®š

### 2. ä»£ç å®¡æŸ¥
- æ£€æŸ¥å˜é‡ä½œç”¨åŸŸå†²çª
- éªŒè¯æ¨¡å—å¯¼å…¥çš„æ­£ç¡®ä½¿ç”¨
- ç¡®ä¿å±€éƒ¨å˜é‡ä¸è¦†ç›–å…¨å±€åç§°

### 3. æµ‹è¯•è¦†ç›–
- æ·»åŠ å•å…ƒæµ‹è¯•éªŒè¯æ¨¡å—å¯¼å…¥
- æµ‹è¯•å…³é”®å‡½æ•°çš„ç‹¬ç«‹è¿è¡Œ
- éªŒè¯æ•°æ®ç®¡é“çš„ç«¯åˆ°ç«¯æµç¨‹

## æ€»ç»“

è¿™æ¬¡ä¿®å¤è§£å†³äº†ä¸€ä¸ªå…¸å‹çš„Pythonå˜é‡ä½œç”¨åŸŸé—®é¢˜ã€‚é€šè¿‡ç®€å•çš„å˜é‡é‡å‘½åï¼Œæˆ‘ä»¬ï¼š

1. **æ¢å¤äº†æ•°æ®ç®¡é“åŠŸèƒ½** - ç°åœ¨å¯ä»¥æ­£å¸¸æŠ½å–å’Œå¤„ç†æ•°æ®
2. **æé«˜äº†ä»£ç è´¨é‡** - é¿å…äº†å˜é‡åå†²çªçš„æ½œåœ¨é—®é¢˜
3. **ç¡®ä¿äº†ç³»ç»Ÿç¨³å®šæ€§** - æ•°æ®ç®¡é“ç°åœ¨å¯ä»¥å¯é åœ°è¿è¡Œ

ä¿®å¤åçš„ç³»ç»Ÿå·²ç»é€šè¿‡äº†å…¨é¢æµ‹è¯•ï¼Œå¯ä»¥æ­£å¸¸è¿›è¡Œæ•°æ®åˆå§‹åŒ–å’Œå› å­è®¡ç®—å·¥ä½œã€‚