# 智能数据管道使用指南

## V3.3 新增功能：智能日期判断

`run_daily_pipeline.py` 现在具备智能日期判断功能，能够自动识别最合适的处理日期，避免重复获取已存在的数据。

## 智能判断逻辑

### 1. 时间智能判断
- **交易日 + 已过收盘时间(15:30)**: 使用当天数据
- **交易日 + 未到收盘时间**: 使用上一个交易日数据  
- **非交易日(周末/节假日)**: 使用最近的交易日数据

### 2. 数据存在性检查
- 检查日线数据是否已存在
- 检查因子数据是否已存在
- 智能判断是否需要跳过处理

### 3. 处理策略
- **数据完整**: 跳过处理，避免重复计算
- **数据缺失**: 执行相应的数据获取和计算
- **部分缺失**: 只处理缺失的部分

## 使用示例

### 场景1: 周一凌晨运行
```bash
python run_daily_pipeline.py
```
**智能判断结果**:
- 识别今天是周一，不是交易日
- 自动选择上周五作为目标日期
- 检查上周五数据是否已存在
- 如果已存在，跳过处理

### 场景2: 交易日盘中运行
```bash
python run_daily_pipeline.py
```
**智能判断结果**:
- 识别今天是交易日但未到收盘时间
- 自动选择上一个交易日
- 避免获取不完整的当日数据

### 场景3: 交易日收盘后运行
```bash
python run_daily_pipeline.py
```
**智能判断结果**:
- 识别今天是交易日且已过收盘时间
- 使用当天作为目标日期
- 获取完整的当日数据

## 日志输出示例

```
===== 启动智能统一数据管道 =====
===== 智能确定最新可用交易日 =====
今天(20250721)是交易日但未到收盘时间，使用上一交易日: 20250718
确定最新可用交易日: 20250718
数据存在状态检查:
  - 日线数据: 存在 (5413 条)
  - 因子数据: 不存在 (0 条)
📊 将处理交易日: 20250718
```

## 性能优化效果

### 避免重复处理
- **传统方式**: 每次运行都会检查所有历史日期
- **智能方式**: 只检查最新需要的日期

### 减少API调用
- **传统方式**: 可能重复获取已存在的数据
- **智能方式**: 检查数据存在性，避免重复调用

### 提升运行效率
- **传统方式**: 处理多个日期，耗时较长
- **智能方式**: 通常只处理1个日期，快速完成

## 配置选项

### 收盘时间设置
默认收盘时间为15:30，可在代码中修改：
```python
market_close_time = datetime.strptime("15:30", "%H:%M").time()
```

### 数据完整性阈值
默认因子数据>100条认为完整，可调整：
```python
result['should_skip'] = result['factor_data_exists'] and result['factor_data_count'] > 100
```

## 错误处理

### 回退机制
如果智能判断失败，自动回退到传统模式：
```
智能日期确定失败，回退到传统模式: [错误信息]
===== 使用传统方法确定需要处理的交易日列表 =====
```

### 异常处理
- 网络异常: 使用当前日期作为备选
- 数据库异常: 记录错误但继续处理
- API异常: 回退到传统模式

## 最佳实践

### 1. 定时任务设置
```bash
# 每个交易日收盘后30分钟执行
0 16 * * 1-5 cd /path/to/project && python run_daily_pipeline.py
```

### 2. 手动运行
```bash
# 检查今天是否需要处理
python run_daily_pipeline.py

# 如果需要强制处理所有缺失日期，可以修改代码使用传统模式
```

### 3. 监控建议
- 关注日志中的"跳过处理"信息
- 定期检查数据完整性
- 监控API调用频率的减少

## 总结

智能数据管道显著提升了系统效率：
- ✅ 自动识别最佳处理时间
- ✅ 避免重复数据获取
- ✅ 减少不必要的API调用
- ✅ 提升整体运行速度
- ✅ 增强系统稳定性

特别适合在周一凌晨、节假日后等场景下使用，能够智能地处理非交易日的数据更新需求。